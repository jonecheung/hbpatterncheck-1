<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Visual Search Test - FINAL</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .upload { margin: 20px 0; padding: 20px; border: 2px dashed #0066cc; border-radius: 8px; }
        .version { color: green; font-weight: bold; margin: 10px 0; font-size: 18px; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .result { border: 2px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; }
        .result h3 { margin-top: 0; color: #0066cc; }
        .result img { width: 100%; height: auto; border: 1px solid #ccc; }
        .stats { font-size: 14px; margin: 10px 0; }
        .query-section { background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        button { background: #0066cc; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0052a3; }
    </style>
</head>
<body>
    <h1>üî¨ Visual Search Test</h1>
    <div class="version">‚úÖ FINAL VERSION - No Cache + Images</div>
    
    <div class="upload">
        <h2>Upload Chromatograph (PDF or Image)</h2>
        <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg">
        <button onclick="search()">üîç Search (No Cache)</button>
    </div>
    
    <div id="query" class="query-section" style="display:none;"></div>
    <div id="results" class="results-grid"></div>
    
    <script>
    async function search() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) { alert('Please select a file'); return; }
        
        // Show query image
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('query').style.display = 'block';
            document.getElementById('query').innerHTML = `
                <h2>üì§ Your Query</h2>
                <p><strong>File:</strong> ${file.name}</p>
                <img src="${e.target.result}" style="max-width: 500px; border: 2px solid #4caf50;">
            `;
        };
        reader.readAsDataURL(file);
        
        const formData = new FormData();
        formData.append('file', file);
        
        document.getElementById('results').innerHTML = '<p style="text-align:center;">üîç Searching with NEW position-based filter (no cache)...</p>';
        
        try {
            // Add cache-busting timestamp to prevent browser caching
            const timestamp = new Date().getTime();
            const response = await fetch(`http://localhost:8000/api/visual-search?top_k=3&_t=${timestamp}&llm_screen=true`, {
                method: 'POST',
                body: formData,
                cache: 'no-cache'
            });
            
            const data = await response.json();
            displayResults(data);
        } catch (error) {
            document.getElementById('results').innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
        }
    }
    
    function displayResults(data) {
        const resultsDiv = document.getElementById('results');
        const results = data.results || [];
        const queryFeatures = data.query_features || {};
        const total = data.total || results.length;
        
        if (results.length === 0) {
            resultsDiv.innerHTML = '<p>No results found.</p>';
            return;
        }
        
        let html = `<h2 style="grid-column: 1/-1;">üéØ Found ${results.length}/${total} Similar Patterns:</h2>
                    <p style="grid-column: 1/-1; font-size: 16px;"><strong>Query peaks detected:</strong> ${queryFeatures.num_peaks || 'N/A'} 
                    <span style="color: green; font-weight: bold;">‚úÖ Position-based matching active!</span></p>`;
        
        results.forEach((r, i) => {
            const overall = (r.similarity * 100).toFixed(1);
            const clip = (r.clip_similarity * 100).toFixed(1);
            const peak = (r.peak_similarity * 100).toFixed(1);
            const displayName = r.image_file || r.image_url || 'unknown';
            
            // Use image_url from API; fallback to constructed path if needed
            let imagePath = '';
            if (r.image_url) {
                // Ensure absolute URL
                imagePath = r.image_url.startsWith('http')
                    ? r.image_url
                    : `http://localhost:8000${r.image_url}`;
            } else if (r.image_file) {
                const imageFile = r.image_file;
                if (r.source === 'main_database') {
                    imagePath = `http://localhost:8000/api/images/cropped_main/${imageFile.replace('main_', '').replace('reference_', '')}`;
                } else {
                    imagePath = `http://localhost:8000/api/images/cropped_reference/${imageFile.replace('reference_', '').replace('main_', '')}`;
                }
            } else {
                imagePath = '';
            }
            
            html += `
                <div class="result">
                    <h3>#${i+1}: ${overall}%</h3>
                    <img src="${imagePath}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22200%22%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%23999%22%3EImage: ${encodeURIComponent(displayName)}%3C/text%3E%3C/svg%3E';">
                    <div class="stats">
                        <p><strong>CLIP:</strong> ${clip}% | <strong>Peak:</strong> ${peak}%</p>
                        <p><strong>Peaks Found:</strong> ${r.num_peaks || 'N/A'}</p>
                        <p><strong>Category:</strong> ${(r.category || 'unknown').replace(/_/g, ' ')}</p>
                        <p><strong>System:</strong> ${(r.system_type || 'unknown').replace(/_/g, ' ')}</p>
                        <p style="font-size: 11px; color: #666;"><strong>File:</strong> ${displayName}</p>
                    </div>
                </div>
            `;
        });
        
        resultsDiv.innerHTML = html;
    }
    </script>
</body>
</html>
